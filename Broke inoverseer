-- Entity Script cho Doors (executor)
-- Y√™u c·∫ßu: Player kh√¥ng nh√¨n th√¨ b·ªã ƒëu·ªïi, nh√¨n th√¨ ƒë·ª©ng y√™n
-- N·∫øu player tr·ªën trong t·ªß, entity s·∫Ω ƒë·ª©ng tr∆∞·ªõc t·ªß, c√°ch 10 studs
-- Entity h√∫t m√°u khi b·∫Øt, bi·∫øn m·∫•t sau khi m·ªü 3 c·ª≠a ti·∫øp theo

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

-- üü¢ ID model entity b·∫°n s·∫Ω t·ª± th√™m v√†o
local entityId = "rbxassetid://89978287886918"

-- Spawn entity ·ªü ph√≤ng hi·ªán t·∫°i
local currentRoom = workspace.CurrentRooms:FindFirstChild(tostring(ReplicatedStorage.GameData.LatestRoom.Value))
if not currentRoom then return end

local roomEntrance = currentRoom:FindFirstChild("RoomEntrance")
local roomExit = currentRoom:FindFirstChild("RoomExit")

-- ch·ªçn v·ªã tr√≠ spawn ng·∫´u nhi√™n trong ph√≤ng
local randomPos = currentRoom:FindFirstChild("Assets") and currentRoom.Assets:GetChildren()[math.random(1, #currentRoom.Assets)]
local spawnPos = randomPos and randomPos.Position or (roomEntrance.Position + (roomExit.Position - roomEntrance.Position) * math.random())

local entity = game:GetObjects(entityId)[1]
entity.Parent = workspace
entity:MoveTo(spawnPos)

local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
local holding = false
local entityActive = true
local holdConnection, bloodDrainConnection

-- üîé Check player c√≥ nh√¨n entity kh√¥ng
local function IsLookingAtEntity()
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("Head") then return false end
    local head = char.Head
    local lookVec = head.CFrame.LookVector
    local dir = (entity.PrimaryPart.Position - head.Position).Unit
    return lookVec:Dot(dir) > 0.5 -- player nh√¨n v·ªÅ ph√≠a entity
end

-- üõèÔ∏è Check player c√≥ ƒëang tr·ªën trong t·ªß kh√¥ng
local function IsInCloset()
    local char = LocalPlayer.Character
    if not char then return false end
    return char:FindFirstChild("HiddenPlayer") ~= nil
end

-- ü©∏ B·∫Øt v√† h√∫t m√°u
local function HoldPlayer()
    if holding then return end
    holding = true
    if humanoid then
        humanoid.WalkSpeed = 0
        humanoid.JumpPower = 0
    end

    bloodDrainConnection = RunService.Heartbeat:Connect(function()
        if humanoid and humanoid.Health > 0 then
            humanoid.Health = humanoid.Health - 1
firesignal(game.ReplicatedStorage.RemotesFolder.DeathHint.OnClientEvent, {"Oh..","Interesting","Seems like you died to a sneaky one","Well, In-Overseer likes playing hide and seek..","Next time, try to look at him until open the next door.."},"Blue")

game.ReplicatedStorage.GameStats["Player_".. game.Players.LocalPlayer.Name].Total.DeathCause.Value = "In-Overseer"
        end
    end)
end

-- üõë Th·∫£ player v√† xo√° entity
local function ReleasePlayer()
    entityActive = false
    holding = false
    if humanoid then
        humanoid.WalkSpeed = 16
        humanoid.JumpPower = 50
    end
    if holdConnection then holdConnection:Disconnect() end
    if bloodDrainConnection then bloodDrainConnection:Disconnect() end
    if entity then entity:Destroy() end
end

-- üëÅÔ∏è Theo d√µi h√†nh vi entity
RunService.Heartbeat:Connect(function(dt)
    if not entityActive or not entity or holding == true then return end
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end
    local playerPos = char.HumanoidRootPart.Position

    if IsInCloset() then
        -- Player trong t·ªß: entity ƒë·∫øn tr∆∞·ªõc t·ªß, ƒë·ª©ng c√°ch 10 studs ƒë·ªëi di·ªán
        local targetPos = playerPos - (char.HumanoidRootPart.CFrame.LookVector * 10)
        entity:SetPrimaryPartCFrame(CFrame.new(targetPos, playerPos))
    else
        if IsLookingAtEntity() then
            -- Player nh√¨n: ƒë·ª©ng im
        else
            -- Player kh√¥ng nh√¨n: di chuy·ªÉn v·ªÅ player
            local dir = (playerPos - entity.PrimaryPart.Position).Unit
            entity:SetPrimaryPartCFrame(entity.PrimaryPart.CFrame + dir * dt * 15)

            if (entity.PrimaryPart.Position - playerPos).Magnitude < 5 then
                HoldPlayer()
            end
        end
    end
end)

-- ‚è≥ Bi·∫øn m·∫•t sau 3 c·ª≠a
local opened = 0
ReplicatedStorage.GameData.LatestRoom.Changed:Connect(function()
    opened += 1
    if opened >= 3 then
        ReleasePlayer()
    end
end)
