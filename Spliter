local ENTITY_ID = 88912878653519      -- <-- Thay báº±ng id model cá»§a báº¡n
local RISE_TIME = 3              -- thá»i gian trá»“i lÃªn (giÃ¢y)
local SPAWN_DEPTH = 6            -- spawn dÆ°á»›i máº·t Ä‘áº¥t bao nhiÃªu studs
local MAX_ROOM_SEARCH_DISTANCE = 150
local HITBOX_SIZE = 20           -- hitbox entity
local SHAKE_MAX_OFFSET = 2       -- khoáº£ng cÃ¡ch rung cá»±c Ä‘áº¡i (studs)
local SHAKE_DISTANCE = 20        -- khoáº£ng cÃ¡ch tá»‘i Ä‘a Ä‘á»ƒ rung máº¡nh

-- ====== SERVICES ======
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
if not player then return end

local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart",5)
if not hrp then return end

-- ====== TÃŒM PHÃ’NG ======
local rooms = {}
for _, m in pairs(workspace:GetDescendants()) do
    if m:IsA("Model") and m:FindFirstChild("RoomEntrance") and m:FindFirstChild("RoomExit") then
        table.insert(rooms, m)
    end
end

if #rooms == 0 then warn("KhÃ´ng tÃ¬m tháº¥y phÃ²ng nÃ o"); return end

local function midpoint(a,b) return (a.Position + b.Position)/2 end
local chosenRoom
local bestDist = math.huge
for _, room in ipairs(rooms) do
    local ent = room:FindFirstChild("RoomEntrance")
    local ex = room:FindFirstChild("RoomExit")
    if ent:IsA("BasePart") and ex:IsA("BasePart") then
        local mid = midpoint(ent, ex)
        local d = (hrp.Position - mid).Magnitude
        if d < bestDist and d <= MAX_ROOM_SEARCH_DISTANCE then
            bestDist = d
            chosenRoom = room
        end
    end
end
if not chosenRoom then warn("KhÃ´ng tÃ¬m tháº¥y phÃ²ng phÃ¹ há»£p gáº§n ngÆ°á»i chÆ¡i"); return end

local entrance = chosenRoom:FindFirstChild("RoomEntrance")
local exitpart = chosenRoom:FindFirstChild("RoomExit")
local spawnPos = midpoint(entrance, exitpart)

-- ====== LOAD ENTITY ======
local success, asset = pcall(function()
    return game:GetObjects("rbxassetid://" .. tostring(ENTITY_ID))
end)
if not success or #asset == 0 then warn("KhÃ´ng load Ä‘Æ°á»£c entity"); return end

local model = asset[1]
if model:IsA("Model")==false then
    for _, v in ipairs(model:GetChildren()) do
        if v:IsA("Model") then model = v; break end
    end
end

model.Parent = workspace

-- Äáº£m báº£o model cÃ³ PrimaryPart
local function setAnyPrimary(m)
    if m.PrimaryPart then return true end
    for _, v in ipairs(m:GetDescendants()) do
        if v:IsA("BasePart") then
            m.PrimaryPart = v
            return true
        end
    end
    return false
end
if not setAnyPrimary(model) then model:Destroy(); warn("Model khÃ´ng cÃ³ BasePart"); return end

-- ====== SPAWN DÆ¯á»šI Máº¶T Äáº¤T ======
local startCFrame = CFrame.new(spawnPos - Vector3.new(0, SPAWN_DEPTH, 0))
model:SetPrimaryPartCFrame(startCFrame)

local targetCFrame = CFrame.new(spawnPos)
local tween = TweenService:Create(model.PrimaryPart, TweenInfo.new(RISE_TIME,Enum.EasingStyle.Quad,Enum.EasingDirection.Out), {CFrame = targetCFrame})
tween:Play()

-- ====== HITBOX ======
local hitbox = Instance.new("Part")
hitbox.Size = Vector3.new(HITBOX_SIZE,HITBOX_SIZE,HITBOX_SIZE)
hitbox.Name = "Hitbox"
hitbox.Transparency = 1
hitbox.Anchored = true
hitbox.CanCollide = false
hitbox.CFrame = model.PrimaryPart.CFrame
hitbox.Parent = workspace

-- Khi player cháº¡m hitbox = cháº¿t
hitbox.Touched:Connect(function(other)
    local h = other.Parent:FindFirstChild("Humanoid")
    if h then
        h.Health = 0

firesignal(game.ReplicatedStorage.RemotesFolder.DeathHint.OnClientEvent,
                                        {"You died to who called.. Spliter","You touched it..",
                                        "It's dangerous..","Be careful next time.",
                                        "Maybe you will get lucky."},
                                        "Blue")

                                    game.ReplicatedStorage.GameStats["Player_"..
game.Players.LocalPlayer.Name].Total.DeathCause.Value = "Spliter"
    end
end)

-- ====== RUNG THEO KHOáº¢NG CÃCH ======
RunService.RenderStepped:Connect(function()
    local distance = (hrp.Position - model.PrimaryPart.Position).Magnitude
    local intensity = math.clamp(1 - distance/SHAKE_DISTANCE, 0, 1) * SHAKE_MAX_OFFSET
    local offset = Vector3.new(
        math.random()*intensity*2 - intensity,
        math.random()*intensity*2 - intensity,
        math.random()*intensity*2 - intensity
    )
    model:SetPrimaryPartCFrame(targetCFrame + offset)
    hitbox.CFrame = model.PrimaryPart.CFrame
end)

wait(5)
game.Workspace.Spliter:Destroy()
game.Workspace.Hitbox:Destroy()

-- Split-1
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local Debris = game:GetService("Debris")

local MODEL_ID = "97321639009420" -- thay báº±ng model id entity
local ENTITY_HEIGHT_OFFSET = 1
local MIN_TWEEN_TIME = 2
local MAX_TWEEN_TIME = 4

local entityModel
local hitbox
local stopMoving = false

-- ðŸ“Œ Láº¥y trung tÃ¢m phÃ²ng
local function getRoomCenterAndSize(room)
    local cf, size = room:GetBoundingBox()
    return cf, size
end

-- ðŸ“Œ Spawn entity
local function SpawnEntity()
    local latest = ReplicatedStorage:FindFirstChild("GameData") and ReplicatedStorage.GameData:FindFirstChild("LatestRoom")
    if not latest then return end
    
    -- âš¡ Láº¥y phÃ²ng hiá»‡n táº¡i
    local room = Workspace.CurrentRooms:FindFirstChild(tostring(latest.Value))
    if not room then return end

    local centerCFrame, roomSize = getRoomCenterAndSize(room)
    if not centerCFrame then return end

    -- âš¡ Láº¥y RoomEntrance vÃ  RoomExit
    local entrance = room:FindFirstChild("RoomEntrance")
    local exit = room:FindFirstChild("RoomExit")
    if not (entrance and exit and entrance:IsA("BasePart") and exit:IsA("BasePart")) then
        warn("âš ï¸ RoomEntrance hoáº·c RoomExit khÃ´ng tá»“n táº¡i á»Ÿ room "..tostring(latest.Value))
        return
    end

    -- Trung Ä‘iá»ƒm giá»¯a entrance vÃ  exit
    local midPos = (entrance.Position + exit.Position) / 2
    local spawnPos = midPos + Vector3.new(0, ENTITY_HEIGHT_OFFSET, 0)

    -- Load model
    local model = game:GetObjects("rbxassetid://"..MODEL_ID)[1]
    model.Parent = Workspace
    entityModel = model

    if not model.PrimaryPart then
        for _, part in ipairs(model:GetDescendants()) do
            if part:IsA("BasePart") then
                model.PrimaryPart = part
                break
            end
        end
    end
    if not model.PrimaryPart then
        warn("âš ï¸ Model khÃ´ng cÃ³ PrimaryPart")
        return
    end

    model:SetPrimaryPartCFrame(CFrame.new(spawnPos))

    -- Hitbox
    hitbox = Instance.new("Part")
    hitbox.Size = Vector3.new(15, 15, 15)
    hitbox.Transparency = 1
    hitbox.Anchored = true
    hitbox.CanCollide = false
    hitbox.Parent = model

    RunService.Heartbeat:Connect(function()
        if model.PrimaryPart then
            hitbox.CFrame = model.PrimaryPart.CFrame
        end
    end)

    -- Khi cháº¡m: -5 mÃ¡u + knockback + hook cháº¿t
    local touchedDebounces = {}
    hitbox.Touched:Connect(function(part)
        local character = part:FindFirstAncestorOfClass("Model")
        if not character then return end
        local humanoid = character:FindFirstChild("Humanoid")
        local root = character:FindFirstChild("HumanoidRootPart")
        if not humanoid or not root then return end
        if touchedDebounces[character] then return end
        touchedDebounces[character] = true

        -- ÄÃ¡nh dáº¥u cháº¿t bá»Ÿi entity nÃ y
        local tag = humanoid:FindFirstChild("KilledByEntity")
        if not tag then
            tag = Instance.new("BoolValue")
            tag.Name = "KilledByEntity"
            tag.Value = true
            tag.Parent = humanoid
        end

        -- GÃ¢y damage
        humanoid:TakeDamage(5)

        -- Knockback
        local dir = (root.Position - model.PrimaryPart.Position)
        if dir.Magnitude == 0 then dir = Vector3.new(0, 0, 1) end
        local bv = Instance.new("BodyVelocity")
        bv.Velocity = dir.Unit * 50
        bv.MaxForce = Vector3.new(1e5, 1e5, 1e5)
        bv.Parent = root
        Debris:AddItem(bv, 0.15)

        task.delay(0.25, function() touchedDebounces[character] = nil end)

        -- Hook cháº¿t (chá»‰ gáº¯n 1 láº§n cho má»—i humanoid)
        if not humanoid:FindFirstChild("DeathHooked") then
            local marker = Instance.new("BoolValue")
            marker.Name = "DeathHooked"
            marker.Parent = humanoid

            humanoid.Died:Connect(function()
                if humanoid:FindFirstChild("KilledByEntity") then
                    
                    warn("Player Ä‘Ã£ cháº¿t bá»Ÿi thá»±c thá»ƒ!")
                    -- VÃ­ dá»¥:
                    firesignal(game.ReplicatedStorage.RemotesFolder.DeathHint.OnClientEvent, {"You died to one of the Spliter's parts","It called Split-1","It's blind but it can track your location by your footsteps","Try to avoid it when it's trying to attack you","I trust you."},"Blue")

game.ReplicatedStorage.GameStats["Player_".. game.Players.LocalPlayer.Name].Total.DeathCause.Value = "Split-1"
                end
            end)
        end
    end)

    -- XoÃ¡ khi qua cá»­a tiáº¿p theo
    latest:GetPropertyChangedSignal("Value"):Connect(function()
        if entityModel and entityModel.Parent then
            entityModel:Destroy()
            stopMoving = true
        end
    end)

    -- Di chuyá»ƒn sau 3s
    task.delay(3, function()
        while model.Parent and not stopMoving do
            local halfX, halfZ = roomSize.X/2 - 3, roomSize.Z/2 - 3
            local rx = (math.random() * 2 - 1) * halfX
            local rz = (math.random() * 2 - 1) * halfZ
            local targetPos = Vector3.new(centerCFrame.Position.X + rx, spawnPos.Y, centerCFrame.Position.Z + rz)

            -- thá»‰nh thoáº£ng Ä‘uá»•i player
            if math.random() < 0.3 then
                local player = Players.LocalPlayer
                if player and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                    local root = player.Character.HumanoidRootPart
                    targetPos = Vector3.new(root.Position.X, spawnPos.Y, root.Position.Z)
                end
            end

            local tweenTime = math.random(MIN_TWEEN_TIME, MAX_TWEEN_TIME)
            local tween = TweenService:Create(
                model.PrimaryPart,
                TweenInfo.new(tweenTime, Enum.EasingStyle.Linear),
                {CFrame = CFrame.new(targetPos)}
            )
            tween:Play()
            tween.Completed:Wait()

            task.wait(0.2)
        end
    end)
end

SpawnEntity()

-- Split-2
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local Debris = game:GetService("Debris")

local MODEL_ID = "85672013993837" -- thay báº±ng model id entity
local ENTITY_HEIGHT_OFFSET = 1
local MIN_TWEEN_TIME = 2
local MAX_TWEEN_TIME = 4

local entityModel
local hitbox
local stopMoving = false

-- ðŸ“Œ Láº¥y trung tÃ¢m phÃ²ng
local function getRoomCenterAndSize(room)
    local cf, size = room:GetBoundingBox()
    return cf, size
end

-- ðŸ“Œ Spawn entity
local function SpawnEntity()
    local latest = ReplicatedStorage:FindFirstChild("GameData") and ReplicatedStorage.GameData:FindFirstChild("LatestRoom")
    if not latest then return end
    
    -- âš¡ Láº¥y phÃ²ng hiá»‡n táº¡i
    local room = Workspace.CurrentRooms:FindFirstChild(tostring(latest.Value))
    if not room then return end

    local centerCFrame, roomSize = getRoomCenterAndSize(room)
    if not centerCFrame then return end

    -- âš¡ Láº¥y RoomEntrance vÃ  RoomExit
    local entrance = room:FindFirstChild("RoomEntrance")
    local exit = room:FindFirstChild("RoomExit")
    if not (entrance and exit and entrance:IsA("BasePart") and exit:IsA("BasePart")) then
        warn("âš ï¸ RoomEntrance hoáº·c RoomExit khÃ´ng tá»“n táº¡i á»Ÿ room "..tostring(latest.Value))
        return
    end

    -- Trung Ä‘iá»ƒm giá»¯a entrance vÃ  exit
    local midPos = (entrance.Position + exit.Position) / 2
    local spawnPos = midPos + Vector3.new(0, ENTITY_HEIGHT_OFFSET, 0)

    -- Load model
    local model = game:GetObjects("rbxassetid://"..MODEL_ID)[1]
    model.Parent = Workspace
    entityModel = model

    if not model.PrimaryPart then
        for _, part in ipairs(model:GetDescendants()) do
            if part:IsA("BasePart") then
                model.PrimaryPart = part
                break
            end
        end
    end
    if not model.PrimaryPart then
        warn("âš ï¸ Model khÃ´ng cÃ³ PrimaryPart")
        return
    end

    model:SetPrimaryPartCFrame(CFrame.new(spawnPos))

    -- Hitbox
    hitbox = Instance.new("Part")
    hitbox.Size = Vector3.new(15, 15, 15)
    hitbox.Transparency = 1
    hitbox.Anchored = true
    hitbox.CanCollide = false
    hitbox.Parent = model

    RunService.Heartbeat:Connect(function()
        if model.PrimaryPart then
            hitbox.CFrame = model.PrimaryPart.CFrame
        end
    end)

    -- Khi cháº¡m: -5 mÃ¡u + knockback + hook cháº¿t
    local touchedDebounces = {}
    hitbox.Touched:Connect(function(part)
        local character = part:FindFirstAncestorOfClass("Model")
        if not character then return end
        local humanoid = character:FindFirstChild("Humanoid")
        local root = character:FindFirstChild("HumanoidRootPart")
        if not humanoid or not root then return end
        if touchedDebounces[character] then return end
        touchedDebounces[character] = true

        -- ÄÃ¡nh dáº¥u cháº¿t bá»Ÿi entity nÃ y
        local tag = humanoid:FindFirstChild("KilledByEntity")
        if not tag then
            tag = Instance.new("BoolValue")
            tag.Name = "KilledByEntity"
            tag.Value = true
            tag.Parent = humanoid
        end

        -- GÃ¢y damage
        humanoid:TakeDamage(10)

        -- Knockback
        local dir = (root.Position - model.PrimaryPart.Position)
        if dir.Magnitude == 0 then dir = Vector3.new(0, 0, 1) end
        local bv = Instance.new("BodyVelocity")
        bv.Velocity = dir.Unit * 50
        bv.MaxForce = Vector3.new(1e5, 1e5, 1e5)
        bv.Parent = root
        Debris:AddItem(bv, 0.15)

        task.delay(0.25, function() touchedDebounces[character] = nil end)

        -- Hook cháº¿t (chá»‰ gáº¯n 1 láº§n cho má»—i humanoid)
        if not humanoid:FindFirstChild("DeathHooked") then
            local marker = Instance.new("BoolValue")
            marker.Name = "DeathHooked"
            marker.Parent = humanoid

            humanoid.Died:Connect(function()
                if humanoid:FindFirstChild("KilledByEntity") then
                    
                    warn("Player Ä‘Ã£ cháº¿t bá»Ÿi thá»±c thá»ƒ!")
                    -- VÃ­ dá»¥:
                    firesignal(game.ReplicatedStorage.RemotesFolder.DeathHint.OnClientEvent, {"You died to one of the Spliter's parts","It called Split-2","Same as Split-1, but it doesn't have eyes","That's why it cant see","Its very easy to avoid it, so i know you can do better next time!"},"Blue")

game.ReplicatedStorage.GameStats["Player_".. game.Players.LocalPlayer.Name].Total.DeathCause.Value = "Split-2"
                end
            end)
        end
    end)

    -- XoÃ¡ khi qua cá»­a tiáº¿p theo
    latest:GetPropertyChangedSignal("Value"):Connect(function()
        if entityModel and entityModel.Parent then
            entityModel:Destroy()
            stopMoving = true
        end
    end)

    -- Di chuyá»ƒn sau 3s
    task.delay(3, function()
        while model.Parent and not stopMoving do
            local halfX, halfZ = roomSize.X/2 - 3, roomSize.Z/2 - 3
            local rx = (math.random() * 2 - 1) * halfX
            local rz = (math.random() * 2 - 1) * halfZ
            local targetPos = Vector3.new(centerCFrame.Position.X + rx, spawnPos.Y, centerCFrame.Position.Z + rz)

            -- thá»‰nh thoáº£ng Ä‘uá»•i player
            if math.random() < 0.3 then
                local player = Players.LocalPlayer
                if player and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                    local root = player.Character.HumanoidRootPart
                    targetPos = Vector3.new(root.Position.X, spawnPos.Y, root.Position.Z)
                end
            end

            local tweenTime = math.random(MIN_TWEEN_TIME, MAX_TWEEN_TIME)
            local tween = TweenService:Create(
                model.PrimaryPart,
                TweenInfo.new(tweenTime, Enum.EasingStyle.Linear),
                {CFrame = CFrame.new(targetPos)}
            )
            tween:Play()
            tween.Completed:Wait()

            task.wait(0.2)
        end
    end)
end

SpawnEntity()
