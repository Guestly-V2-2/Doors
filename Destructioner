-- Unfinished Destructioner (spawn gi·ªØa Entrance & Exit c·ªßa ph√≤ng hi·ªán t·∫°i + death hook)

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local Debris = game:GetService("Debris")

local MODEL_ID = "138147967630112" -- thay b·∫±ng model id entity
local ENTITY_HEIGHT_OFFSET = 1
local MIN_TWEEN_TIME = 2
local MAX_TWEEN_TIME = 4

local entityModel
local hitbox
local stopMoving = false

-- üìå L·∫•y trung t√¢m ph√≤ng
local function getRoomCenterAndSize(room)
    local cf, size = room:GetBoundingBox()
    return cf, size
end

-- üìå Spawn entity
local function SpawnEntity()
    local latest = ReplicatedStorage:FindFirstChild("GameData") and ReplicatedStorage.GameData:FindFirstChild("LatestRoom")
    if not latest then return end
    
    -- ‚ö° L·∫•y ph√≤ng hi·ªán t·∫°i
    local room = Workspace.CurrentRooms:FindFirstChild(tostring(latest.Value))
    if not room then return end

    local centerCFrame, roomSize = getRoomCenterAndSize(room)
    if not centerCFrame then return end

    -- ‚ö° L·∫•y RoomEntrance v√† RoomExit
    local entrance = room:FindFirstChild("RoomEntrance")
    local exit = room:FindFirstChild("RoomExit")
    if not (entrance and exit and entrance:IsA("BasePart") and exit:IsA("BasePart")) then
        warn("‚ö†Ô∏è RoomEntrance ho·∫∑c RoomExit kh√¥ng t·ªìn t·∫°i ·ªü room "..tostring(latest.Value))
        return
    end

    -- Trung ƒëi·ªÉm gi·ªØa entrance v√† exit
    local midPos = (entrance.Position + exit.Position) / 2
    local spawnPos = midPos + Vector3.new(0, ENTITY_HEIGHT_OFFSET, 0)

    -- Load model
    local model = game:GetObjects("rbxassetid://"..MODEL_ID)[1]
    model.Parent = Workspace
    entityModel = model

    if not model.PrimaryPart then
        for _, part in ipairs(model:GetDescendants()) do
            if part:IsA("BasePart") then
                model.PrimaryPart = part
                break
            end
        end
    end
    if not model.PrimaryPart then
        warn("‚ö†Ô∏è Model kh√¥ng c√≥ PrimaryPart")
        return
    end

    model:SetPrimaryPartCFrame(CFrame.new(spawnPos))

    -- Hitbox
    hitbox = Instance.new("Part")
    hitbox.Size = Vector3.new(15, 15, 15)
    hitbox.Transparency = 1
    hitbox.Anchored = true
    hitbox.CanCollide = false
    hitbox.Parent = model

    RunService.Heartbeat:Connect(function()
        if model.PrimaryPart then
            hitbox.CFrame = model.PrimaryPart.CFrame
        end
    end)

    -- Khi ch·∫°m: -5 m√°u + knockback + hook ch·∫øt
    local touchedDebounces = {}
    hitbox.Touched:Connect(function(part)
        local character = part:FindFirstAncestorOfClass("Model")
        if not character then return end
        local humanoid = character:FindFirstChild("Humanoid")
        local root = character:FindFirstChild("HumanoidRootPart")
        if not humanoid or not root then return end
        if touchedDebounces[character] then return end
        touchedDebounces[character] = true

        -- ƒê√°nh d·∫•u ch·∫øt b·ªüi entity n√†y
        local tag = humanoid:FindFirstChild("KilledByEntity")
        if not tag then
            tag = Instance.new("BoolValue")
            tag.Name = "KilledByEntity"
            tag.Value = true
            tag.Parent = humanoid
        end

        -- G√¢y damage
        humanoid:TakeDamage(5)

        -- Knockback
        local dir = (root.Position - model.PrimaryPart.Position)
        if dir.Magnitude == 0 then dir = Vector3.new(0, 0, 1) end
        local bv = Instance.new("BodyVelocity")
        bv.Velocity = dir.Unit * 50
        bv.MaxForce = Vector3.new(1e5, 1e5, 1e5)
        bv.Parent = root
        Debris:AddItem(bv, 0.15)

        task.delay(0.25, function() touchedDebounces[character] = nil end)

        -- Hook ch·∫øt (ch·ªâ g·∫Øn 1 l·∫ßn cho m·ªói humanoid)
        if not humanoid:FindFirstChild("DeathHooked") then
            local marker = Instance.new("BoolValue")
            marker.Name = "DeathHooked"
            marker.Parent = humanoid

            humanoid.Died:Connect(function()
                if humanoid:FindFirstChild("KilledByEntity") then
                    
                    warn("Player ƒë√£ ch·∫øt b·ªüi th·ª±c th·ªÉ!")
                    -- V√≠ d·ª•:
                    firesignal(game.ReplicatedStorage.RemotesFolder.DeathHint.OnClientEvent, {"Huh?","What's now?","Oh i see.. It seems like you dead to Destructioner","That guy never want anyone that near him","Just don't go near him next time... Idiot."},"Blue")

game.ReplicatedStorage.GameStats["Player_".. game.Players.LocalPlayer.Name].Total.DeathCause.Value = "Destructioner"
                end
            end)
        end
    end)

    -- Xo√° khi qua c·ª≠a ti·∫øp theo
    latest:GetPropertyChangedSignal("Value"):Connect(function()
        if entityModel and entityModel.Parent then
            entityModel:Destroy()
            stopMoving = true
        end
    end)

    -- Di chuy·ªÉn sau 3s
    task.delay(3, function()
        while model.Parent and not stopMoving do
            local halfX, halfZ = roomSize.X/2 - 3, roomSize.Z/2 - 3
            local rx = (math.random() * 2 - 1) * halfX
            local rz = (math.random() * 2 - 1) * halfZ
            local targetPos = Vector3.new(centerCFrame.Position.X + rx, spawnPos.Y, centerCFrame.Position.Z + rz)

            -- th·ªânh tho·∫£ng ƒëu·ªïi player
            if math.random() < 0.3 then
                local player = Players.LocalPlayer
                if player and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                    local root = player.Character.HumanoidRootPart
                    targetPos = Vector3.new(root.Position.X, spawnPos.Y, root.Position.Z)
                end
            end

            local tweenTime = math.random(MIN_TWEEN_TIME, MAX_TWEEN_TIME)
            local tween = TweenService:Create(
                model.PrimaryPart,
                TweenInfo.new(tweenTime, Enum.EasingStyle.Linear),
                {CFrame = CFrame.new(targetPos)}
            )
            tween:Play()
            tween.Completed:Wait()

            task.wait(0.2)
        end
    end)
end

SpawnEntity()
